{% extends "core/base.html" %}  {% load static %}

{% block title %}ChatBOT - MTI IA{% endblock %}

{% block content %}
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-200">
    <div x-data="{ showConfirm: false, isMobileMenuOpen: false }" class="h-screen flex flex-col">
        
        <div class="md:hidden bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700 flex items-center justify-between px-4 py-3">
            <h1 class="text-xl font-semibold">Assistente IA</h1>
            <button @click="isMobileMenuOpen = !isMobileMenuOpen" class="p-2 rounded-md text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                <i class="bi bi-list text-2xl"></i>
            </button>
        </div>
        <div x-show="isMobileMenuOpen" @click.away="isMobileMenuOpen = false" x-transition class="md:hidden bg-white dark:bg-gray-800 shadow-lg rounded-b-lg z-50 absolute w-full">
            <nav class="px-4 py-3 space-y-2">
                <a href="{% url 'chat' %}" class="flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg"><i class="bi bi-chat-right-text-fill mr-3 text-lg"></i> ChatBOT</a>
                <a href="{% url 'document_list' %}" class="flex items-center px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg"><i class="bi bi-file-earmark-zip-fill mr-3 text-lg"></i> Documentos</a>
                <a href="{% url 'dashboards' %}" class="flex items-center px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg"><i class="bi bi-bar-chart-line-fill mr-3 text-lg"></i> Dashboards</a>
                <a href="{% url 'landing_page' %}" class="flex items-center px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg"><i class="bi bi-house-door-fill mr-3 text-lg"></i> Tela Inicial</a>
                <button @click="showConfirm = true" class="w-full flex items-center px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg"><i class="bi bi-plus-square mr-3 text-lg"></i> Nova Conversa</button>
            </nav>
        </div>

        <div class="flex flex-1 overflow-hidden">
            <aside class="hidden md:flex w-64 flex-shrink-0 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex-col">
                <div class="h-16 flex items-center justify-center border-b border-gray-200 dark:border-gray-700">
                    <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-200">Navegação</h2>
                </div>
                <nav class="flex-1 flex flex-col px-4 py-4 space-y-2">
                    <a href="{% url 'chat' %}" class="flex items-center px-4 py-2.5 text-sm font-medium text-white bg-blue-600 rounded-lg"><i class="bi bi-chat-right-text-fill mr-3 text-lg"></i> ChatBOT</a>
                    <a href="{% url 'document_list' %}" class="flex items-center px-4 py-2.5 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg"><i class="bi bi-file-earmark-zip-fill mr-3 text-lg"></i> Documentos</a>
                    <a href="{% url 'dashboards' %}" class="flex items-center px-4 py-2.5 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg"><i class="bi bi-bar-chart-line-fill mr-3 text-lg"></i> Dashboards</a>
                </nav>
                <div class="mt-auto px-4 py-4 space-y-2 border-t border-gray-200 dark:border-gray-700">
                    <a href="{% url 'landing_page' %}" class="flex items-center px-4 py-2.5 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg"><i class="bi bi-house-door-fill mr-3 text-lg"></i> Tela Inicial</a>
                    <button @click="showConfirm = true" class="w-full flex items-center px-4 py-2.5 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg"><i class="bi bi-plus-square mr-3 text-lg"></i> Nova Conversa</button>
                </div>
                <div class="p-4 border-t border-gray-200 dark:border-gray-700">
                    <p class="text-xs text-gray-400">© {% now "Y" %} MTI IA</p>
                </div>
            </aside>

            <div class="flex-1 flex flex-col overflow-hidden bg-gray-50 dark:bg-gray-900">
                <div class="bg-white/80 dark:bg-gray-800/50 backdrop-blur-sm shadow-sm border-b border-gray-200 dark:border-gray-700 px-6 py-4 flex justify-between items-center">
                    <h1 class="text-xl font-semibold">Assistente IA</h1>
                    <button @click="showConfirm = true" type="button" class="hidden md:flex items-center text-gray-500 hover:text-blue-600 dark:hover:text-blue-400 transition-colors px-3 py-1.5 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="bi bi-plus-square mr-2"></i><span class="text-sm">Nova Conversa</span>
                    </button>
                </div>

                <div id="chat-window" class="flex-1 overflow-y-auto p-4 space-y-6 scroll-smooth scrollbar-hide">
                    
                    {% for chat in chat_messages %}
                        <div class="flex items-start gap-3 justify-end">
                            <div class="bg-blue-600 p-4 rounded-xl rounded-br-none shadow-lg max-w-[85%]">
                                <p class="text-sm text-white">{{ chat.message }}</p>
                            </div>
                            <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold flex-shrink-0 shadow-md">
                                <i class="bi bi-person-fill"></i>
                            </div>
                        </div>

                        <div class="flex items-start gap-3 justify-start group relative">
                            <div class="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold flex-shrink-0 shadow-md">IA</div>
                            <div class="bg-white dark:bg-gray-700 p-4 rounded-xl rounded-tl-none shadow-lg max-w-[85%] w-full">
                                <div class="prose prose-sm dark:prose-invert max-w-none markdown-content">{{ chat.response|safe }}</div>
                                <div class="mt-4 pt-2 border-t border-gray-200 dark:border-gray-600 flex items-center justify-end gap-2 action-bar" data-message-id="{{ chat.id }}">
                                    {% if chat.feedback == 0 %}
                                        <span class="text-xs text-gray-400">Esta resposta foi útil?</span>
                                        <button class="feedback-btn p-1.5 text-gray-500 hover:text-green-500 rounded-full hover:bg-gray-100 dark:hover:bg-gray-600" data-feedback="1" title="Gostei"><i class="bi bi-hand-thumbs-up"></i></button>
                                        <button class="feedback-btn p-1.5 text-gray-500 hover:text-red-500 rounded-full hover:bg-gray-100 dark:hover:bg-gray-600" data-feedback="-1" title="Não Gostei"><i class="bi bi-hand-thumbs-down"></i></button>
                                    {% elif chat.feedback == 1 %}
                                        <span class="text-xs text-green-600 dark:text-green-400 font-medium">Obrigado pelo seu feedback!</span>
                                    {% else %}
                                        <span class="text-xs text-red-600 dark:text-red-400 font-medium">Obrigado, vamos melhorar.</span>
                                    {% endif %}
                                    <button class="copy-button p-1.5 text-gray-500 hover:text-blue-500 rounded-full hover:bg-gray-100 dark:hover:bg-gray-600" title="Copiar resposta" data-copy-text="{{ chat.response }}"><i class="bi bi-clipboard"></i></button>
                                </div>
                            </div>
                        </div>
                    {% empty %}
                        <div class="flex flex-col items-center justify-center h-full text-center py-12 prompt-suggestion-container">
                            <div class="text-5xl font-black bg-gradient-to-r from-blue-600 to-blue-400 dark:from-blue-400 dark:to-cyan-300 bg-clip-text text-transparent mb-6">MTI IA</div>
                            <p class="text-lg font-medium text-gray-600 dark:text-gray-300 mb-8">Como posso te ajudar hoje?</p>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 max-w-lg w-full">
                                <button class="prompt-suggestion text-left p-4 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-xl transition-all border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md">
                                    <p class="text-sm font-semibold text-gray-800 dark:text-gray-100">Fazer um resumo</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">sobre o Regimento Interno da UGGOV</p>
                                </button>
                                <button class="prompt-suggestion text-left p-4 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-xl transition-all border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md">
                                    <p class="text-sm font-semibold text-gray-800 dark:text-gray-100">Listar os riscos</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">associados à unidade UGGOV</p>
                                </button>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <div class="bg-white/80 dark:bg-gray-800/50 backdrop-blur-sm p-4 border-t border-gray-200 dark:border-gray-700">
                    <form id="chat-form" class="flex items-center space-x-3 max-w-4xl mx-auto">
                        {% csrf_token %}
                        <div class="relative flex-1">
                            <input type="text" id="chat-input" placeholder="Digite sua mensagem para o assistente..." autocomplete="off" class="w-full px-5 py-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow pr-12">
                        </div>
                        <button type="submit" class="bg-blue-600 text-white rounded-full w-12 h-12 flex-shrink-0 flex items-center justify-center shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 focus:ring-blue-500 transform hover:scale-105 transition">
                            <span class="sr-only">Enviar</span><i class="bi bi-send-fill text-xl"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div x-show="showConfirm" x-transition class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4" style="display: none;">
            <div @click.away="showConfirm = false" class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-sm w-full p-6 text-center">
                <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-blue-100 dark:bg-blue-900/30">
                    <i class="bi bi-sparkles text-2xl text-blue-600 dark:text-blue-400"></i>
                </div>
                <h3 class="mt-4 text-lg font-semibold text-gray-900 dark:text-white">Iniciar Nova Conversa</h3>
                <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Isso irá limpar a tela para um novo diálogo. Seu histórico anterior será mantido.</p>
                <div class="mt-6 flex justify-center space-x-4">
                    <button @click="showConfirm = false" type="button" class="px-6 py-2 text-sm font-medium rounded-md bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">Cancelar</button>
                    <a href="{% url 'chat' %}" class="inline-block px-6 py-2 text-sm font-medium rounded-md bg-blue-600 text-white hover:bg-blue-700 transition-colors">Sim, Iniciar</a>
                </div>
            </div>
        </div>
    </div>
</body>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    function parseMarkdown(text) {
        if (window.marked) {
            return marked.parse(text, { breaks: true, gfm: true });
        }
        return text.replace(/\n/g, '<br>');
    }

    // Renderiza o markdown do conteúdo já carregado na página (histórico)
    document.querySelectorAll('.markdown-content').forEach(el => {
        el.innerHTML = parseMarkdown(el.textContent.trim());
    });

    const chatWindow = document.getElementById('chat-window');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    
    // VARIÁVEIS INJETADAS PELO DJANGO
    const sessionId = '{{ chat_session_id }}';
    const chatApiUrl = '{% url "chat_api" %}';
    const feedbackApiUrl = '{% url "feedback_api" %}';
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    function smoothScrollToBottom() {
        chatWindow.scrollTo({ top: chatWindow.scrollHeight, behavior: 'smooth' });
    }
    
    // Rola para o final ao carregar a página
    setTimeout(() => {
        chatWindow.scrollTo({ top: chatWindow.scrollHeight, behavior: 'auto' });
    }, 100);

    function addMessage(message, sender, messageId = null) {
        const uniqueId = sender + '-' + (messageId || Date.now());
        let messageHtml = '';

        if (sender === 'user') {
            messageHtml = `
                <div id="${uniqueId}" class="flex items-start gap-3 justify-end animate-fade-in">
                    <div class="bg-blue-600 p-4 rounded-xl rounded-br-none shadow-lg max-w-[85%]">
                        <p class="text-sm text-white">${message}</p>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold flex-shrink-0 shadow-md">
                        <i class="bi bi-person-fill"></i>
                    </div>
                </div>`;
        } else {
            const escapedMessage = message.replace(/"/g, '&quot;');
            const htmlContent = parseMarkdown(message);
            const actionBarHtml = messageId ? `
                <div class="mt-4 pt-2 border-t border-gray-200 dark:border-gray-600 flex items-center justify-end gap-2 action-bar" data-message-id="${messageId}">
                    <span class="text-xs text-gray-400">Esta resposta foi útil?</span>
                    <button class="feedback-btn p-1.5 text-gray-500 hover:text-green-500 rounded-full hover:bg-gray-100 dark:hover:bg-gray-600" data-feedback="1" title="Gostei"><i class="bi bi-hand-thumbs-up"></i></button>
                    <button class="feedback-btn p-1.5 text-gray-500 hover:text-red-500 rounded-full hover:bg-gray-100 dark:hover:bg-gray-600" data-feedback="-1" title="Não Gostei"><i class="bi bi-hand-thumbs-down"></i></button>
                    <button class="copy-button p-1.5 text-gray-500 hover:text-blue-500 rounded-full hover:bg-gray-100 dark:hover:bg-gray-600" title="Copiar resposta" data-copy-text="${escapedMessage}"><i class="bi bi-clipboard"></i></button>
                </div>` : '';

            messageHtml = `
                <div id="${uniqueId}" class="flex items-start gap-3 justify-start animate-fade-in">
                    <div class="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold flex-shrink-0 shadow-md">IA</div>
                    <div class="bg-white dark:bg-gray-700 p-4 rounded-xl rounded-tl-none shadow-lg max-w-[85%] w-full">
                        <div class="prose prose-sm dark:prose-invert max-w-none">${htmlContent}</div>
                        ${actionBarHtml}
                    </div>
                </div>`;
        }
        chatWindow.insertAdjacentHTML('beforeend', messageHtml);
        smoothScrollToBottom();
    }

    function showTypingIndicator() {
        const typingHtml = `
            <div id="typing-indicator" class="flex items-start gap-3 justify-start animate-fade-in">
                <div class="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold flex-shrink-0 shadow-md">IA</div>
                <div class="bg-white dark:bg-gray-700 p-4 rounded-xl rounded-tl-none shadow-lg">
                    <div class="typing-indicator" style="display: inline-flex; align-items: center;">
                        <div class="typing-dot" style="width: 8px; height: 8px; border-radius: 50%; background-color: #3b82f6; margin-right: 4px; animation: typing-dot 1.5s infinite ease-in-out;"></div>
                        <div class="typing-dot" style="width: 8px; height: 8px; border-radius: 50%; background-color: #3b82f6; margin-right: 4px; animation: typing-dot 1.5s infinite ease-in-out .3s;"></div>
                        <div class="typing-dot" style="width: 8px; height: 8px; border-radius: 50%; background-color: #3b82f6; margin-right: 0; animation: typing-dot 1.5s infinite ease-in-out .6s;"></div>
                    </div>
                </div>
            </div>`;
        chatWindow.insertAdjacentHTML('beforeend', typingHtml);
        smoothScrollToBottom();
    }

    function removeTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) indicator.remove();
    }

    chatForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const userMessage = chatInput.value.trim();
        if (!userMessage) return;
        
        const suggestionsContainer = document.querySelector('.prompt-suggestion-container');
        if (suggestionsContainer) { suggestionsContainer.remove(); }
        
        addMessage(userMessage, 'user');
        chatInput.value = '';
        showTypingIndicator();

        try {
            const response = await fetch(chatApiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                body: JSON.stringify({ message: userMessage, session_id: sessionId })
            });

            removeTypingIndicator();
            if (!response.ok) { throw new Error('A resposta da rede não foi OK.'); }
            
            const data = await response.json();
            addMessage(data.response, 'bot', data.message_id);

        } catch (error) {
            removeTypingIndicator();
            addMessage('<strong>Erro:</strong> Não foi possível conectar ao servidor de IA.', 'bot');
        }
    });

    chatWindow.addEventListener('click', async function(e) {
        const feedbackButton = e.target.closest('.feedback-btn');
        const copyButton = e.target.closest('.copy-button');
        const suggestionButton = e.target.closest('.prompt-suggestion');

        if (feedbackButton) {
            const actionBar = feedbackButton.parentElement;
            const messageId = actionBar.dataset.messageId;
            const feedbackValue = feedbackButton.dataset.feedback;
            
            try {
                const response = await fetch(feedbackApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                    body: JSON.stringify({ message_id: messageId, feedback: parseInt(feedbackValue) })
                });

                if (!response.ok) throw new Error('Falha ao enviar feedback.');
                const result = await response.json();

                if (result.success) {
                    let feedbackMessage = feedbackValue == 1 
                        ? '<span class="text-xs text-green-600 dark:text-green-400 font-medium">Obrigado pelo seu feedback!</span>' 
                        : '<span class="text-xs text-red-600 dark:text-red-400 font-medium">Obrigado, vamos melhorar.</span>';
                    actionBar.innerHTML = feedbackMessage;
                } else {
                    throw new Error(result.error || 'Erro desconhecido.');
                }
            } catch (error) {
                actionBar.innerHTML = '<span class="text-xs text-red-500">Erro ao registrar.</span>';
            }
        }
        
        if (copyButton) {
            const textToCopy = copyButton.dataset.copyText;
            navigator.clipboard.writeText(textToCopy).then(() => {
                const originalIcon = copyButton.innerHTML;
                copyButton.innerHTML = '<i class="bi bi-check-lg text-green-500"></i>';
                setTimeout(() => { copyButton.innerHTML = originalIcon; }, 2000);
            });
        }

        if (suggestionButton) {
            const title = suggestionButton.querySelector('p:first-child').textContent;
            const subtitle = suggestionButton.querySelector('p:last-child').textContent;
            const fullPrompt = `${title} ${subtitle}`;
            chatInput.value = fullPrompt;
            chatForm.dispatchEvent(new Event('submit', { cancelable: true }));
        }
    });
});
</script>
<style>
/* Estilos para animações e indicador de digitação */
@keyframes fade-in {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
.animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
.scrollbar-hide::-webkit-scrollbar { display: none; }
.scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
@keyframes typing-dot {
    0%, 60%, 100% { transform: translateY(0); opacity: 1; }
    30% { transform: translateY(-5px); opacity: 0.5; }
}
</style>
{% endblock %}