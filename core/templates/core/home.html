{% extends "core/base.html" %}
{% load static %}

{% block title %}ChatBOT - MTI IA{% endblock %}

{% block content %}
<!-- Container principal que inicializa o Alpine.js para o modal de confirmação -->
<div x-data="{ showConfirm: false }">
    <!-- Modal de Confirmação para "Iniciar Nova Conversa" -->
    <div x-show="showConfirm" 
         x-transition:enter="ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[70] flex items-center justify-center p-4" 
         style="display: none;">

        <div @click.away="showConfirm = false" class="bg-white dark:bg-slate-800 rounded-lg shadow-2xl max-w-sm w-full p-6 text-center">
            <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-uggovBlue/10 dark:bg-uggovBlue/20">
                <i class="bi bi-sparkles text-2xl text-uggovBlue dark:text-sky-300"></i>
            </div>
            <h3 class="mt-4 text-lg font-semibold text-slate-900 dark:text-white">Iniciar Nova Conversa</h3>
            <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">
                Isso irá limpar a tela para um novo diálogo. Seu histórico anterior será mantido.
            </p>
            <div class="mt-6 flex justify-center space-x-4">
                <button @click="showConfirm = false" type="button" class="px-6 py-2 text-sm font-medium rounded-md bg-slate-100 dark:bg-slate-700 text-slate-800 dark:text-slate-200 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">Cancelar</button>
                <a href="{% url 'chat' %}" class="inline-block px-6 py-2 text-sm font-medium rounded-md bg-uggovBlue text-white hover:bg-uggovBlue/90 transition-colors">
                    Sim, Iniciar
                </a>
            </div>
        </div>
    </div>

    <!-- Layout de duas colunas (Sidebar e Conteúdo do Chat) -->
    <div class="flex" style="height: calc(100vh - 4rem);">
        <aside class="w-64 flex-shrink-0 bg-white dark:bg-slate-800/50 border-r border-slate-200 dark:border-slate-700/50 hidden md:flex flex-col">
            <div class="h-16 flex items-center justify-center border-b border-slate-200 dark:border-slate-700/50">
                <h2 class="text-lg font-semibold text-slate-700 dark:text-slate-200">Navegação</h2>
            </div>
            
            <!-- A tag <nav> agora tem 'flex-grow' para empurrar o link final para baixo -->
            <nav class="flex-1 flex flex-col px-4 py-4">
                <div class="space-y-2">
                    <a href="{% url 'chat' %}" class="flex items-center px-4 py-2.5 text-sm font-medium text-white bg-uggovBlue rounded-lg shadow-sm"><i class="bi bi-chat-right-text-fill mr-3 text-lg"></i> ChatBOT</a>
                    <a href="{% url 'document_list' %}" class="flex items-center px-4 py-2.5 text-sm font-medium text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors"><i class="bi bi-file-earmark-zip-fill mr-3 text-lg"></i> Documentos</a>
                    <a href="{% url 'dashboards' %}" class="flex items-center px-4 py-2.5 text-sm font-medium text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors"><i class="bi bi-bar-chart-line-fill mr-3 text-lg"></i> Dashboards</a>
                </div>
                <!-- 
                  ===============================================================
                  NOVA FUNCIONALIDADE ADICIONADA
                  - mt-auto empurra este link para o final do contêiner flex.
                  ===============================================================
                -->
                <div class="mt-auto">
                    <a href="{% url 'landing_page' %}" class="flex items-center px-4 py-2.5 text-sm font-medium text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors">
                        <i class="bi bi-house-door-fill mr-3 text-lg"></i>
                        Tela Inicial
                    </a>
                </div>
            </nav>

            <div class="p-4 border-t border-slate-200 dark:border-slate-700/50">
                <p class="text-xs text-slate-400">© {% now "Y" %} MTI IA</p>
            </div>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden bg-slate-100 dark:bg-slate-900">
            <div class="bg-white/80 dark:bg-slate-800/50 backdrop-blur-sm shadow-sm border-b border-slate-200 dark:border-slate-700/50 px-6 py-4 flex justify-between items-center">
                <h1 class="text-xl font-semibold text-slate-800 dark:text-slate-100">Assistente IA</h1>
                <button @click="showConfirm = true" type="button" class="text-slate-500 hover:text-uggovBlue dark:hover:text-sky-300 transition-colors" title="Iniciar nova conversa">
                    <i class="bi bi-plus-square"></i>
                    <span class="hidden sm:inline ml-1 text-sm">Nova Conversa</span>
                </button>
            </div>

            <div id="chat-window" class="flex-1 overflow-y-auto p-6 space-y-6">
                {% for chat in chat_messages %}
                    <div class="flex items-start gap-4 justify-end">
                        <div class="bg-uggovBlue p-4 rounded-xl rounded-br-none shadow-lg max-w-[80%]">
                            <p class="text-sm text-white">{{ chat.message }}</p>
                        </div>
                        <img class="w-10 h-10 rounded-full object-cover shadow-md" src="{{ user.profile.image.url }}" alt="Sua foto de perfil">
                    </div>
                    <div class="flex items-start gap-4 justify-start group relative">
                        <div class="w-10 h-10 rounded-full bg-uggovBlue text-white flex items-center justify-center font-bold flex-shrink-0 shadow-md">IA</div>
                        <div class="bg-white dark:bg-slate-700 p-4 rounded-xl rounded-tl-none shadow-lg max-w-[85%] w-full">
                            <div class="prose prose-sm dark:prose-invert max-w-none markdown-content">{{ chat.response }}</div>
                            <div class="mt-4 pt-2 border-t border-slate-200 dark:border-slate-600 flex items-center justify-end gap-2 action-bar" data-message-id="{{ chat.id }}">
                                {% if chat.feedback == 0 %}
                                    <span class="text-xs text-slate-400">Esta resposta foi útil?</span>
                                    <button class="feedback-btn p-1.5 text-slate-500 hover:text-green-500 rounded-full hover:bg-slate-100 dark:hover:bg-slate-600" data-feedback="1" title="Gostei"><i class="bi bi-hand-thumbs-up"></i></button>
                                    <button class="feedback-btn p-1.5 text-slate-500 hover:text-red-500 rounded-full hover:bg-slate-100 dark:hover:bg-slate-600" data-feedback="-1" title="Não Gostei"><i class="bi bi-hand-thumbs-down"></i></button>
                                {% elif chat.feedback == 1 %}
                                    <span class="text-xs text-green-600 dark:text-green-400 font-medium">Obrigado pelo seu feedback!</span>
                                {% else %}
                                    <span class="text-xs text-red-600 dark:text-red-400 font-medium">Obrigado, vamos melhorar.</span>
                                {% endif %}
                                <button class="copy-button p-1.5 text-slate-500 hover:text-uggovBlue rounded-full hover:bg-slate-100 dark:hover:bg-slate-600" title="Copiar resposta" data-copy-text="{{ chat.response }}"><i class="bi bi-clipboard"></i></button>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <div class="flex flex-col items-center justify-center h-full text-center prompt-suggestion-container">
                        <span class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-uggovBlue-800 to-uggovBlue-500 dark:from-sky-400 dark:to-cyan-300 mb-4">MTI IA</span>
                        <p class="text-lg font-medium text-slate-600 dark:text-slate-300">Como posso te ajudar hoje?</p>
                        <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-3 max-w-lg w-full">
                            <button class="prompt-suggestion text-left p-3 bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-lg transition-colors border border-slate-200 dark:border-slate-700">
                                <p class="text-sm font-semibold text-slate-800 dark:text-slate-100">Fazer um resumo</p>
                                <p class="text-xs text-slate-500 dark:text-slate-400">sobre o Regimento Interno da UGGOV</p>
                            </button>
                            <button class="prompt-suggestion text-left p-3 bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-lg transition-colors border border-slate-200 dark:border-slate-700">
                                <p class="text-sm font-semibold text-slate-800 dark:text-slate-100">Listar os riscos</p>
                                <p class="text-xs text-slate-500 dark:text-slate-400">associados à unidade UGGOV</p>
                            </button>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <div class="bg-white/80 dark:bg-slate-800/50 backdrop-blur-sm p-4 border-t border-slate-200 dark:border-slate-700/50">
               <form id="chat-form" class="flex items-center space-x-4 max-w-4xl mx-auto">
                    <input type="text" id="chat-input" placeholder="Digite sua mensagem para o assistente..." autocomplete="off" class="w-full px-5 py-3 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 rounded-full focus:outline-none focus:ring-2 focus:ring-uggovBlue transition-shadow">
                    <button type="submit" class="bg-uggovBlue text-white rounded-full w-12 h-12 flex-shrink-0 flex items-center justify-center shadow-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-slate-800 focus:ring-uggovBlue transform hover:scale-105 transition"><span class="sr-only">Enviar</span><i class="bi bi-send-fill text-xl"></i></button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    function parseMarkdown(text) {
        return window.marked ? marked.parse(text, { breaks: true, gfm: true }) : text.replace(/\n/g, '<br>');
    }

    document.querySelectorAll('.markdown-content').forEach(el => {
        el.innerHTML = parseMarkdown(el.textContent);
    });

    const chatWindow = document.getElementById('chat-window');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const sessionId = '{{ chat_session_id }}';
    const chatApiUrl = '{% url "chat_api" %}';
    const feedbackApiUrl = '{% url "feedback_api" %}';

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    function addMessage(message, sender, messageId = null) {
        const uniqueId = sender + '-' + (messageId || Date.now());
        let messageHtml = '';

        if (sender === 'user') {
            messageHtml = `<div id="${uniqueId}" class="flex items-start gap-4 justify-end animate-fade-in"><div class="bg-uggovBlue p-4 rounded-xl rounded-br-none shadow-lg max-w-[80%]"><p class="text-sm text-white">${message}</p></div><img class="w-10 h-10 rounded-full object-cover shadow-md" src="{{ user.profile.image.url }}" alt="Sua foto de perfil"></div>`;
        } else {
            const escapedMessage = message.replace(/"/g, '&quot;');
            const htmlContent = parseMarkdown(message);
            const actionBarHtml = messageId 
                ? `<div class="mt-4 pt-2 border-t border-slate-200 dark:border-slate-600 flex items-center justify-end gap-2 action-bar" data-message-id="${messageId}"><span class="text-xs text-slate-400">Esta resposta foi útil?</span><button class="feedback-btn p-1.5 text-slate-500 hover:text-green-500 rounded-full hover:bg-slate-100 dark:hover:bg-slate-600" data-feedback="1" title="Gostei"><i class="bi bi-hand-thumbs-up"></i></button><button class="feedback-btn p-1.5 text-slate-500 hover:text-red-500 rounded-full hover:bg-slate-100 dark:hover:bg-slate-600" data-feedback="-1" title="Não Gostei"><i class="bi bi-hand-thumbs-down"></i></button><button class="copy-button p-1.5 text-slate-500 hover:text-uggovBlue rounded-full hover:bg-slate-100 dark:hover:bg-slate-600" title="Copiar resposta" data-copy-text="${escapedMessage}"><i class="bi bi-clipboard"></i></button></div>`
                : '';

            messageHtml = `<div id="${uniqueId}" class="flex items-start gap-4 justify-start group relative animate-fade-in"><div class="w-10 h-10 rounded-full bg-uggovBlue text-white flex items-center justify-center font-bold flex-shrink-0 shadow-md">IA</div><div class="bg-white dark:bg-slate-700 p-4 rounded-xl rounded-tl-none shadow-lg max-w-[85%] w-full"><div class="prose prose-sm dark:prose-invert max-w-none">${htmlContent}</div>${actionBarHtml}</div></div>`;
        }
        chatWindow.insertAdjacentHTML('beforeend', messageHtml);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    let thinkingInterval;
    function showThinkingIndicator() {
        const thinkingHtml = `<div id="thinking-indicator" class="flex items-start gap-4 justify-start animate-fade-in"><div class="w-10 h-10 rounded-full bg-uggovBlue text-white flex items-center justify-center font-bold flex-shrink-0 shadow-md"><i class="bi bi-robot animate-pulse"></i></div><div class="bg-white dark:bg-slate-700 p-4 rounded-xl rounded-tl-none shadow-lg"><div class="flex items-center space-x-3"><svg class="animate-spin h-5 w-5 text-uggovBlue dark:text-sky-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span id="thinking-text" class="text-sm font-medium text-slate-500 dark:text-slate-400 transition-all duration-300">Analisando sua pergunta...</span></div></div></div>`;
        chatWindow.insertAdjacentHTML('beforeend', thinkingHtml);
        chatWindow.scrollTop = chatWindow.scrollHeight;

        setTimeout(() => {
            const thinkingText = document.getElementById('thinking-text');
            if(thinkingText) { thinkingText.textContent = 'Buscando nos documentos...'; }
        }, 1500);
    }
    
    function removeThinkingIndicator() {
        const indicator = document.getElementById('thinking-indicator');
        if (indicator) { indicator.remove(); }
    }

    chatForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const userMessage = chatInput.value.trim();
        if (!userMessage) return;
        const suggestionsContainer = document.querySelector('.prompt-suggestion-container');
        if (suggestionsContainer) { suggestionsContainer.remove(); }
        addMessage(userMessage, 'user');
        chatInput.value = '';
        showThinkingIndicator();
        try {
            const response = await fetch(chatApiUrl, {
                method: 'POST', 
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                body: JSON.stringify({ message: userMessage, session_id: sessionId })
            });
            removeThinkingIndicator();
            if (!response.ok) { throw new Error('Network response was not ok.'); }
            const data = await response.json();
            addMessage(data.response, 'bot', data.message_id); 
        } catch (error) {
            removeThinkingIndicator();
            addMessage('<strong>Erro:</strong> Não foi possível conectar ao servidor de IA.', 'bot');
        }
    });

    chatWindow.addEventListener('click', async function(e) {
        const feedbackButton = e.target.closest('.feedback-btn');
        const copyButton = e.target.closest('.copy-button');
        const suggestionButton = e.target.closest('.prompt-suggestion');

        if (feedbackButton) {
            const actionBar = feedbackButton.parentElement;
            const messageId = actionBar.dataset.messageId;
            const feedbackValue = feedbackButton.dataset.feedback;
            if (!messageId) {
                actionBar.innerHTML = '<span class="text-xs text-red-500">Erro ao registrar.</span>';
                return;
            }
            try {
                const response = await fetch(feedbackApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                    body: JSON.stringify({ message_id: messageId, feedback: parseInt(feedbackValue) })
                });
                if (!response.ok) throw new Error('Falha ao enviar feedback.');
                const result = await response.json();
                if (result.success) {
                    let feedbackMessage = feedbackValue == 1 ? '<span class="text-xs text-green-600 dark:text-green-400 font-medium">Obrigado pelo seu feedback!</span>' : '<span class="text-xs text-red-600 dark:text-red-400 font-medium">Obrigado, vamos melhorar.</span>';
                    actionBar.innerHTML = feedbackMessage;
                } else { throw new Error(result.error || 'Erro desconhecido.'); }
            } catch (error) {
                actionBar.innerHTML = '<span class="text-xs text-red-500">Erro ao registrar.</span>';
            }
        }
        
        if (copyButton) {
            const textToCopy = copyButton.dataset.copyText;
            navigator.clipboard.writeText(textToCopy).then(() => {
                copyButton.innerHTML = '<i class="bi bi-check-lg text-green-500"></i>';
                setTimeout(() => { copyButton.innerHTML = '<i class="bi bi-clipboard"></i>'; }, 2000);
            });
        }
        if (suggestionButton) { 
            const title = suggestionButton.querySelector('p:first-child').textContent;
            const subtitle = suggestionButton.querySelector('p:last-child').textContent;
            const fullPrompt = `${title} ${subtitle}`;
            chatInput.value = fullPrompt;
            chatForm.dispatchEvent(new Event('submit', { cancelable: true }));
         }
    });
});
</script>

<style>
@keyframes fade-in {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
.animate-fade-in {
  animation: fade-in 0.5s ease-out forwards;
}
</style>
{% endblock %}
