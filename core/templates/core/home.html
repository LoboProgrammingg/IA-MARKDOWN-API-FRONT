{% extends "core/base.html" %}
{% load static %}

{% block title %}Assistente IA - MTI GovTech{% endblock %}

{% block page_title %}Assistente IA{% endblock %}
{% block page_title_mobile %}Assistente IA{% endblock %}

{% block extra_head %}
<style>
    /* Estilos para animações e indicador de digitação */
    @keyframes fade-in-up {
        from { opacity: 0; transform: translateY(15px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in-up { animation: fade-in-up 0.4s ease-out forwards; }
    
    .scrollbar-thin::-webkit-scrollbar { width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
    .scrollbar-thin::-webkit-scrollbar-thumb { 
        background: rgba(0, 123, 255, 0.5); 
        border-radius: 10px;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #007BFF; }

    /* Animação do Indicador de Digitação da IA */
    @keyframes scanner {
        0% { transform: translateY(-100%); }
        50% { transform: translateY(100%); }
        100% { transform: translateY(-100%); }
    }
    .scanner-line {
        position: absolute;
        top: 0; left: 0; right: 0;
        height: 2px;
        background: linear-gradient(90deg, transparent, #00F6FF, transparent);
        animation: scanner 2s ease-in-out infinite;
        opacity: 0.8;
    }
</style>
{% endblock %}

{% block content %}
<!-- Container principal do chat, que ocupa toda a altura da 'main' -->
<div x-data="{ showConfirm: false }" class="h-[calc(100vh-8.5rem)] flex flex-col relative -m-6">

    <!-- Janela do Chat -->
    <div id="chat-window" class="flex-1 overflow-y-auto p-6 space-y-8 scroll-smooth scrollbar-thin">
        
        {% for chat in chat_messages %}
            <!-- Mensagem do Usuário -->
            <div class="flex items-start gap-4 justify-end animate-fade-in-up">
                <div class="bg-mti-blue p-4 rounded-2xl rounded-br-lg shadow-lg">
                    <p class="text-white" style="white-space: pre-wrap;">{{ chat.message }}</p>
                </div>
                <div class="w-10 h-10 rounded-full flex-shrink-0 shadow-md object-cover">
                    {% if chat.user.profile.image and chat.user.profile.image.name != 'profile_pics/default.jpg' %}
                        <img src="{{ chat.user.profile.image.url }}" class="w-full h-full rounded-full object-cover" alt="Avatar de {{ chat.user.username }}">
                    {% else %}
                        <div class="w-full h-full rounded-full avatar-initials">{{ chat.user.first_name.0|upper }}{{ chat.user.last_name.0|upper }}</div>
                    {% endif %}
                </div>
            </div>

            <!-- Mensagem da IA -->
            <div class="flex items-start gap-4 justify-start group relative animate-fade-in-up">
                <div class="w-10 h-10 rounded-full bg-mti-accent/20 text-mti-accent flex items-center justify-center flex-shrink-0 shadow-md">
                    <img src="{% static 'img/robot.png' %}" alt="Avatar da IA" class="w-7 h-7">
                </div>
                <div class="glass-effect p-4 rounded-2xl rounded-bl-lg shadow-lg w-full">
                    <div class="prose prose-sm prose-invert max-w-none markdown-content">{{ chat.response|safe }}</div>
                    <div class="mt-4 pt-3 border-t border-mti-border/50 flex items-center justify-end gap-2 action-bar" data-message-id="{{ chat.id }}">
                        {% if chat.feedback == 0 %}
                            <span class="text-xs text-mti-gray mr-auto">Esta resposta foi útil?</span>
                            <button class="feedback-btn p-1.5 text-mti-gray hover:text-green-400 rounded-full hover:bg-mti-deep-blue" data-feedback="1" title="Gostei"><i class="bi bi-hand-thumbs-up-fill"></i></button>
                            <button class="feedback-btn p-1.5 text-mti-gray hover:text-red-500 rounded-full hover:bg-mti-deep-blue" data-feedback="-1" title="Não Gostei"><i class="bi bi-hand-thumbs-down-fill"></i></button>
                        {% elif chat.feedback == 1 %}
                            <span class="text-xs text-green-400 font-medium mr-auto">Obrigado pelo seu feedback!</span>
                        {% else %}
                            <span class="text-xs text-red-400 font-medium mr-auto">Obrigado, vamos melhorar.</span>
                        {% endif %}
                        <button class="copy-button p-1.5 text-mti-gray hover:text-mti-accent rounded-full hover:bg-mti-deep-blue" title="Copiar resposta" data-copy-text="{{ chat.response|escapejs }}"><i class="bi bi-clipboard-fill"></i></button>
                    </div>
                </div>
            </div>
        {% empty %}
            <!-- Tela de Boas-Vindas -->
            <div class="flex flex-col items-center justify-center h-full text-center py-12 prompt-suggestion-container animate-fade-in-up">
                <img src="{% static 'img/robot.png' %}" alt="Logo MTI" class="h-24 w-auto mb-4 opacity-80">
                <h2 class="text-4xl font-bold text-white">Assistente GovTech IA</h2>
                <p class="text-lg text-mti-gray mt-2 mb-10">Estou pronto para ajudar. Como podemos começar?</p>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 max-w-2xl w-full">
                    <button class="prompt-suggestion text-left p-4 glass-effect rounded-xl transition-all duration-300 shadow-lg hover:border-mti-blue hover:scale-105">
                        <p class="font-semibold text-mti-light-gray">Fazer um resumo</p>
                        <p class="text-sm text-mti-gray mt-1">sobre o Regimento Interno da UGGOV</p>
                    </button>
                    <button class="prompt-suggestion text-left p-4 glass-effect rounded-xl transition-all duration-300 shadow-lg hover:border-mti-blue hover:scale-105">
                        <p class="font-semibold text-mti-light-gray">Listar os riscos</p>
                        <p class="text-sm text-mti-gray mt-1">associados à unidade UGGOV</p>
                    </button>
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Formulário de Input Fixo -->
    <div class="p-6 bg-mti-deep-blue/80 backdrop-blur-sm">
        <div class="max-w-4xl mx-auto">
            <form id="chat-form" class="relative">
                {% csrf_token %}
                <textarea id="chat-input" placeholder="Digite sua mensagem para o assistente..." 
                          rows="1"
                          class="w-full px-6 py-4 border-2 border-mti-border bg-mti-dark rounded-2xl text-mti-light-gray resize-none focus:outline-none focus:ring-2 focus:ring-mti-blue focus:border-transparent transition-all pr-20 scrollbar-thin"
                ></textarea>
                <button type="submit" 
                        class="absolute right-4 top-1/2 -translate-y-1/2 bg-mti-blue text-white rounded-full w-12 h-12 flex-shrink-0 flex items-center justify-center shadow-lg hover:bg-mti-accent hover:text-mti-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-mti-dark focus:ring-mti-accent transform hover:scale-105 transition-all duration-200">
                    <span class="sr-only">Enviar</span><i class="bi bi-arrow-up text-xl"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmação para Nova Conversa -->
    <div x-show="showConfirm" x-transition class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4" style="display: none;">
        <div @click.away="showConfirm = false" class="bg-mti-dark border border-mti-border rounded-xl shadow-2xl max-w-sm w-full p-6 text-center">
            <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-mti-blue/20">
                <i class="bi bi-sparkles text-2xl text-mti-accent"></i>
            </div>
            <h3 class="mt-4 text-lg font-semibold text-white">Iniciar Nova Conversa</h3>
            <p class="mt-2 text-sm text-mti-gray">Isso irá limpar a tela para um novo diálogo. Seu histórico anterior será mantido.</p>
            <div class="mt-6 flex justify-center space-x-4">
                <button @click="showConfirm = false" type="button" class="px-6 py-2 text-sm font-medium rounded-md bg-mti-deep-blue text-mti-light-gray hover:bg-mti-border transition-colors">Cancelar</button>
                <a href="{% url 'chat' %}" class="inline-block px-6 py-2 text-sm font-medium rounded-md bg-mti-blue text-white hover:bg-mti-accent hover:text-mti-dark transition-colors">Sim, Iniciar</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    function parseMarkdown(text) {
        if (window.marked) {
            return marked.parse(text, { breaks: true, gfm: true });
        }
        return text.replace(/\n/g, '<br>');
    }

    document.querySelectorAll('.markdown-content').forEach(el => {
        el.innerHTML = parseMarkdown(el.textContent.trim());
    });

    const chatWindow = document.getElementById('chat-window');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    
    const sessionId = '{{ chat_session_id }}';
    const chatApiUrl = '{% url "chat_api" %}';
    const feedbackApiUrl = '{% url "feedback_api" %}';
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const robotAvatarUrl = "{% static 'img/robot.png' %}";

    // Objeto para armazenar os dados do usuário atual de forma segura
    const currentUser = {
        avatar: '{% if user.profile.image and user.profile.image.name != "profile_pics/default.jpg" %}{{ user.profile.image.url }}{% else %}none{% endif %}',
        initials: '{{ user.first_name.0|upper }}{{ user.last_name.0|upper }}'
    };

    // Listener para atualizar os dados do usuário quando o perfil for alterado em outra página
    window.addEventListener('profile-updated', (event) => {
        currentUser.avatar = event.detail.avatar;
    });

    function adjustTextareaHeight() {
        chatInput.style.height = 'auto';
        chatInput.style.height = (chatInput.scrollHeight) + 'px';
    }
    chatInput.addEventListener('input', adjustTextareaHeight);

    function smoothScrollToBottom() {
        chatWindow.scrollTo({ top: chatWindow.scrollHeight, behavior: 'smooth' });
    }
    
    setTimeout(() => {
        chatWindow.scrollTo({ top: chatWindow.scrollHeight, behavior: 'auto' });
    }, 100);

    function addMessage(message, sender, messageId = null) {
        const uniqueId = sender + '-' + (messageId || Date.now());
        let messageHtml = '';

        if (sender === 'user') {
            let avatarHtml = '';
            // CORREÇÃO: Usa o objeto currentUser, que é sempre atualizado e disponível.
            if (currentUser.avatar !== 'none') {
                avatarHtml = `<img src="${currentUser.avatar}" class="w-full h-full rounded-full object-cover" alt="Avatar do usuário">`;
            } else {
                const initials = currentUser.initials || '..';
                avatarHtml = `<div class="w-full h-full rounded-full avatar-initials">${initials}</div>`;
            }

            messageHtml = `
                <div class="flex items-start gap-4 justify-end animate-fade-in-up">
                    <div class="bg-mti-blue p-4 rounded-2xl rounded-br-lg shadow-lg">
                        <p class="text-white" style="white-space: pre-wrap;">${message}</p>
                    </div>
                    <div class="w-10 h-10 rounded-full flex-shrink-0 shadow-md object-cover">
                        ${avatarHtml}
                    </div>
                </div>`;
        } else {
            const escapedMessage = message.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            const htmlContent = parseMarkdown(message);
            const actionBarHtml = messageId ? `
                <div class="mt-4 pt-3 border-t border-mti-border/50 flex items-center justify-end gap-2 action-bar" data-message-id="${messageId}">
                    <span class="text-xs text-mti-gray mr-auto">Esta resposta foi útil?</span>
                    <button class="feedback-btn p-1.5 text-mti-gray hover:text-green-400 rounded-full hover:bg-mti-deep-blue" data-feedback="1" title="Gostei"><i class="bi bi-hand-thumbs-up-fill"></i></button>
                    <button class="feedback-btn p-1.5 text-mti-gray hover:text-red-500 rounded-full hover:bg-mti-deep-blue" data-feedback="-1" title="Não Gostei"><i class="bi bi-hand-thumbs-down-fill"></i></button>
                    <button class="copy-button p-1.5 text-mti-gray hover:text-mti-accent rounded-full hover:bg-mti-deep-blue" title="Copiar resposta" data-copy-text='${escapedMessage}'><i class="bi bi-clipboard-fill"></i></button>
                </div>` : '';

            messageHtml = `
                <div class="flex items-start gap-4 justify-start group relative animate-fade-in-up">
                    <div class="w-10 h-10 rounded-full bg-mti-accent/20 text-mti-accent flex items-center justify-center flex-shrink-0 shadow-md">
                        <img src="${robotAvatarUrl}" alt="Avatar da IA" class="w-7 h-7">
                    </div>
                    <div class="glass-effect p-4 rounded-2xl rounded-bl-lg shadow-lg w-full">
                        <div class="prose prose-sm prose-invert max-w-none markdown-content">${htmlContent}</div>
                        ${actionBarHtml}
                    </div>
                </div>`;
        }
        chatWindow.insertAdjacentHTML('beforeend', messageHtml);
        smoothScrollToBottom();
    }

    function showTypingIndicator() {
        const typingHtml = `
            <div id="typing-indicator" class="flex items-start gap-4 justify-start animate-fade-in-up">
                <div class="relative w-10 h-10 rounded-full bg-mti-accent/20 text-mti-accent flex items-center justify-center flex-shrink-0 shadow-md overflow-hidden">
                    <img src="${robotAvatarUrl}" alt="Avatar da IA" class="w-7 h-7 z-10">
                    <div class="scanner-line"></div>
                </div>
                <div class="glass-effect p-4 rounded-2xl rounded-bl-lg shadow-lg">
                    <p class="text-sm font-medium text-mti-light-gray">Analisando...</p>
                </div>
            </div>`;
        chatWindow.insertAdjacentHTML('beforeend', typingHtml);
        smoothScrollToBottom();
    }

    function removeTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) indicator.remove();
    }

    chatForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const userMessage = chatInput.value.trim();
        if (!userMessage) return;
        
        const suggestionsContainer = document.querySelector('.prompt-suggestion-container');
        if (suggestionsContainer) { suggestionsContainer.remove(); }
        
        addMessage(userMessage, 'user');
        chatInput.value = '';
        adjustTextareaHeight();
        showTypingIndicator();

        try {
            const response = await fetch(chatApiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                body: JSON.stringify({ message: userMessage, session_id: sessionId })
            });

            removeTypingIndicator();
            if (!response.ok) { throw new Error('A resposta da rede não foi OK.'); }
            
            const data = await response.json();
            addMessage(data.response, 'bot', data.message_id);

        } catch (error) {
            removeTypingIndicator();
            addMessage('<strong>Erro:</strong> Não foi possível conectar ao servidor de IA.', 'bot');
        }
    });

    chatInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            chatForm.dispatchEvent(new Event('submit'));
        }
    });

    chatWindow.addEventListener('click', async function(e) {
        const feedbackButton = e.target.closest('.feedback-btn');
        const copyButton = e.target.closest('.copy-button');
        const suggestionButton = e.target.closest('.prompt-suggestion');

        if (feedbackButton) {
            const actionBar = feedbackButton.parentElement;
            const messageId = actionBar.dataset.messageId;
            const feedbackValue = feedbackButton.dataset.feedback;
            
            try {
                const response = await fetch(feedbackApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                    body: JSON.stringify({ message_id: messageId, feedback: parseInt(feedbackValue) })
                });

                if (!response.ok) throw new Error('Falha ao enviar feedback.');
                const result = await response.json();

                if (result.success) {
                    let feedbackMessage = feedbackValue == 1 
                        ? '<span class="text-xs text-green-400 font-medium mr-auto">Obrigado pelo seu feedback!</span>' 
                        : '<span class="text-xs text-red-400 font-medium mr-auto">Obrigado, vamos melhorar.</span>';
                    actionBar.innerHTML = feedbackMessage;
                } else {
                    throw new Error(result.error || 'Erro desconhecido.');
                }
            } catch (error) {
                actionBar.innerHTML = '<span class="text-xs text-red-500">Erro ao registrar.</span>';
            }
        }
        
        if (copyButton) {
            const textToCopy = copyButton.dataset.copyText;
            navigator.clipboard.writeText(textToCopy).then(() => {
                const originalIcon = copyButton.innerHTML;
                copyButton.innerHTML = '<i class="bi bi-check-lg text-green-400"></i>';
                setTimeout(() => { copyButton.innerHTML = originalIcon; }, 2000);
            });
        }

        if (suggestionButton) {
            const title = suggestionButton.querySelector('p:first-child').textContent;
            const subtitle = suggestionButton.querySelector('p:last-child').textContent;
            const fullPrompt = `${title} ${subtitle}`;
            chatInput.value = fullPrompt;
            chatForm.dispatchEvent(new Event('submit', { cancelable: true }));
        }
    });
});
</script>
{% endblock %}
