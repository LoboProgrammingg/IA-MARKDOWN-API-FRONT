{% extends "core/base.html" %}
{% load static %}

{% block title %}{{ post.title }} - MTI IA{% endblock %}

{% block content %}
<div x-data="{ progress: 0, activeHeading: '' }" 
     @scroll.window="
        progress = (window.pageYOffset / (document.body.scrollHeight - window.innerHeight)) * 100;
        
        let headings = document.querySelectorAll('.prose h2, .prose h3');
        let active = '';
        for (let h of headings) {
            if (h.getBoundingClientRect().top < window.innerHeight / 2) {
                active = h.id;
            } else {
                break;
            }
        }
        activeHeading = active;
     ">

    <!-- Barra de Progresso de Leitura -->
    <div class="fixed top-0 left-0 right-0 h-1 bg-uggovBlue dark:bg-sky-400 z-[60]" :style="`width: ${progress}%`"></div>

    <div class="bg-white dark:bg-slate-900">
        <!-- Cabeçalho Cinematográfico Imersivo -->
        <div class="relative h-[50vh] min-h-[400px]">
            <img src="{{ post.featured_image.url }}" alt="Imagem de destaque para {{ post.title }}" class="absolute inset-0 h-full w-full object-cover">
            <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/50 to-transparent"></div>
            <div class="absolute inset-0 flex flex-col justify-end p-6 lg:p-12">
                <div class="mx-auto max-w-3xl text-white">
                    <p class="text-base font-semibold leading-7 text-sky-300">{{ post.get_post_type_display }}</p>
                    <h1 class="mt-2 text-3xl font-bold tracking-tight sm:text-5xl">{{ post.title }}</h1>
                    <p class="mt-4 text-xl leading-8 text-slate-300">{{ post.short_description }}</p>
                    <div class="mt-6 flex items-center gap-x-4">
                        <img src="{{ post.author.profile.image.url }}" alt="Foto de {{ post.author.username }}" class="h-10 w-10 rounded-full object-cover ring-2 ring-white/50">
                        <div class="text-sm leading-6">
                            <p class="font-semibold">{{ post.author.get_full_name|default:post.author.username }}</p>
                            <p class="text-slate-400">{{ post.created_at|date:"d de F, Y" }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Layout Principal do Artigo com Sumário Flutuante -->
        <div class="mx-auto max-w-7xl px-6 lg:px-8 py-16 lg:py-24 grid grid-cols-12 gap-8" id="article-content">
            <aside class="hidden lg:block col-span-3">
                <div class="sticky top-28">
                    <h3 class="text-sm font-semibold uppercase tracking-wider text-slate-600 dark:text-slate-400">Neste Artigo</h3>
                    <nav id="toc-container" class="mt-4 space-y-2 border-l-2 border-slate-200 dark:border-slate-700"></nav>
                </div>
            </aside>
            
            <article class="col-span-12 lg:col-span-9 xl:col-span-7">
                <!-- 
                  ===============================================================
                  NOVA FUNCIONALIDADE ADICIONADA
                  - Botão para voltar para a tela inicial (landing_page)
                  ===============================================================
                -->
                <div class="mb-12">
                    <a href="{% url 'landing_page' %}" class="inline-flex items-center gap-2 text-sm font-medium text-slate-600 dark:text-slate-300 hover:text-uggovBlue dark:hover:text-sky-400 transition-colors">
                        <i class="bi bi-arrow-left"></i>
                        Voltar para Todas as Postagens
                    </a>
                </div>
                
                <div class="prose prose-lg dark:prose-invert max-w-none markdown-content">
                    {{ post.content }}
                </div>
            </article>

            <aside class="hidden xl:block col-span-2">
                 <div class="sticky top-28 space-y-4 text-center">
                    <p class="text-xs font-semibold uppercase text-slate-500">Compartilhar</p>
                    <div class="flex justify-center gap-2">
                        <a href="#" class="flex h-10 w-10 items-center justify-center rounded-full bg-slate-100 dark:bg-slate-800 hover:text-uggovBlue dark:hover:text-sky-400 transition-colors"><i class="bi bi-twitter"></i></a>
                        <a href="#" class="flex h-10 w-10 items-center justify-center rounded-full bg-slate-100 dark:bg-slate-800 hover:text-uggovBlue dark:hover:text-sky-400 transition-colors"><i class="bi bi-linkedin"></i></a>
                        <a href="#" class="flex h-10 w-10 items-center justify-center rounded-full bg-slate-100 dark:bg-slate-800 hover:text-uggovBlue dark:hover:text-sky-400 transition-colors"><i class="bi bi-link-45deg"></i></a>
                    </div>
                </div>
            </aside>
        </div>

        {% if related_posts %}
        <div class="bg-slate-50 dark:bg-slate-900/50 py-24 sm:py-32">
            <div class="mx-auto max-w-7xl px-6 lg:px-8">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold tracking-tight text-slate-900 dark:text-white">Leia a seguir</h2>
                </div>
                <div class="mx-auto mt-10 grid max-w-2xl grid-cols-1 gap-x-8 gap-y-16 lg:mx-0 lg:max-w-none lg:grid-cols-3">
                    {% for related_post in related_posts %}
                        <article class="flex flex-col items-start justify-between transform hover:-translate-y-2 transition-transform duration-300">
                            <div class="relative w-full">
                                <a href="{% url 'post_detail' related_post.slug %}" class="block">
                                    <img src="{{ related_post.featured_image.url }}" alt="Imagem do post {{ related_post.title }}" class="aspect-[16/9] w-full rounded-2xl bg-slate-100 object-cover sm:aspect-[2/1] lg:aspect-[3/2] shadow-lg">
                                    <div class="absolute inset-0 rounded-2xl ring-1 ring-inset ring-slate-900/10"></div>
                                </a>
                            </div>
                            <div class="max-w-xl mt-6">
                                <div class="group relative">
                                    <h3 class="mt-3 text-lg font-semibold leading-6 text-slate-900 dark:text-white">
                                        <a href="{% url 'post_detail' related_post.slug %}"><span class="absolute inset-0"></span>{{ related_post.title }}</a>
                                    </h3>
                                    <p class="mt-3 line-clamp-2 text-sm leading-6 text-slate-600 dark:text-slate-400">{{ related_post.short_description|default:related_post.content|striptags|truncatewords:15 }}</p>
                                </div>
                            </div>
                        </article>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const contentArea = document.querySelector('.markdown-content');
        const tocContainer = document.getElementById('toc-container');

        if (contentArea && tocContainer) {
            if (window.marked) {
                const rawMarkdown = contentArea.textContent;
                contentArea.innerHTML = marked.parse(rawMarkdown, { breaks: true, gfm: true });
            }
            
            const headings = contentArea.querySelectorAll('h2, h3');
            if (headings.length > 0) {
                const tocList = document.createElement('ul');
                tocList.className = 'space-y-2';
                
                headings.forEach((heading, index) => {
                    const id = `heading-${index}`;
                    heading.id = id;

                    const listItem = document.createElement('li');
                    const link = document.createElement('a');
                    
                    link.href = `#${id}`;
                    link.textContent = heading.textContent;
                    link.setAttribute('x-bind:class', `{ 'text-uggovBlue dark:text-sky-400 font-semibold border-uggovBlue dark:border-sky-400': activeHeading === '${id}', 'border-transparent': activeHeading !== '${id}' }`);
                    link.className = 'block border-l-2 pl-4 text-sm transition-colors duration-200 hover:text-uggovBlue dark:hover:text-sky-400';
                    if (heading.tagName === 'H3') {
                        link.classList.add('ml-4');
                    }
                    
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        document.querySelector(this.getAttribute('href')).scrollIntoView({
                            behavior: 'smooth'
                        });
                    });

                    listItem.appendChild(link);
                    tocList.appendChild(listItem);
                });
                tocContainer.appendChild(tocList);
            } else {
                 tocContainer.parentElement.style.display = 'none';
            }
        }
    });
</script>
{% endblock %}
