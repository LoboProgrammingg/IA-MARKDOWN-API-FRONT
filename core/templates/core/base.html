{% load static %}
<!DOCTYPE html>
<html lang="pt-br" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}MTI GovTech IA{% endblock %}</title>
    
    <!-- SCRIPT DO TAILWIND com plugins adicionais -->
    <script src="https://cdn.tailwindcss.com?plugins=typography,forms,aspect-ratio,line-clamp"></script>
    
    <!-- Ícones e Fontes -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="icon" href="{% static 'img/favicon.ico' %}" type="image/x-icon">

    <!-- Fontes Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Configuração Tailwind -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            '50': '#f0f9ff', '100': '#e0f2fe', '200': '#bae6fd', '300': '#7dd3fc',
                            '400': '#38bdf8', '500': '#0ea5e9', '600': '#0284c7', '700': '#0369a1',
                            '800': '#075985', '900': '#0c4a6e',
                        },
                        dark: {
                            '50': '#f8fafc', '100': '#f1f5f9', '200': '#e2e8f0', '300': '#cbd5e1',
                            '400': '#94a3b8', '500': '#64748b', '600': '#475569', '700': '#334155',
                            '800': '#1e293b', '900': '#0f172a', '950': '#020617',
                        },
                        'mti-dark': '#010409',
                        'mti-deep-blue': '#0d1117',
                        'mti-blue': '#007BFF',
                        'mti-accent': '#00F6FF',
                        'mti-gray': '#8b949e',
                        'mti-light-gray': '#c9d1d9',
                        'mti-border': 'rgba(201, 209, 217, 0.1)',
                    },
                    boxShadow: {
                        'glass': '0 4px 30px rgba(0, 0, 0, 0.1)',
                        'card': '0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24)',
                        'card-hover': '0 14px 28px rgba(0, 0, 0, 0.25), 0 10px 10px rgba(0, 0, 0, 0.22)',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' }, },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' }, },
                    }
                }
            }
        }
    </script>
    <style>
        /* Estilos globais refinados */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0d1117; }
        ::-webkit-scrollbar-thumb { 
            background: #3b82f6; 
            border-radius: 10px; 
            border: 2px solid #0d1117;
        }
        ::-webkit-scrollbar-thumb:hover { background: #60a5fa; }
        
        [x-cloak] { display: none !important; }
        
        .glass-effect {
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            background: rgba(13, 17, 23, 0.75);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .avatar-initials {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, #007BFF, #00F6FF);
        }
    </style>
    {% block extra_head %}{% endblock %}
</head>
<body class="min-h-screen bg-mti-deep-blue text-mti-light-gray font-sans antialiased leading-relaxed">

    <div x-data="{
            sidebarOpen: window.innerWidth >= 1024, 
            mobileSidebarOpen: false,
            user: {
                name: '{{ user.get_full_name|default:user.username }}',
                role: '{{ user.profile.unidade|default:"Usuário" }}',
                avatar: '{% if user.profile.image and user.profile.image.name != "profile_pics/default.jpg" %}{{ user.profile.image.url }}{% else %}none{% endif %}',
                initials: '{{ user.first_name.0|upper }}{{ user.last_name.0|upper }}'
            },
            toggleSidebar() {
                if (window.innerWidth >= 1024) {
                    this.sidebarOpen = !this.sidebarOpen;
                } else {
                    this.mobileSidebarOpen = !this.mobileSidebarOpen;
                }
            },
            closeSidebar() {
                if (window.innerWidth < 1024) {
                    this.mobileSidebarOpen = false;
                }
            }
         }" 
         @profile-updated.window="user.name = $event.detail.name; user.avatar = $event.detail.avatar;"
         @resize.window="sidebarOpen = window.innerWidth >= 1024"
         class="flex min-h-screen bg-mti-deep-blue">
        
        <!-- Overlay para mobile -->
        <div x-show="mobileSidebarOpen" 
             @click="mobileSidebarOpen = false"
             x-transition:enter="transition-opacity ease-linear duration-300"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-transition:leave="transition-opacity ease-linear duration-300"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0"
             class="fixed inset-0 z-20 bg-black/50 lg:hidden"
             x-cloak>
        </div>

        <!-- Sidebar (Navegação Principal) -->
        <aside 
            x-show="sidebarOpen || mobileSidebarOpen"
            x-transition:enter="transition ease-in-out duration-300 transform"
            x-transition:enter-start="-translate-x-full"
            x-transition:enter-end="translate-x-0"
            x-transition:leave="transition ease-in-out duration-300 transform"
            x-transition:leave-start="translate-x-0"
            x-transition:leave-end="-translate-x-full"
            @keydown.escape.window="mobileSidebarOpen = false"
            class="fixed inset-y-0 left-0 z-30 w-64 bg-mti-dark border-r border-mti-border flex flex-col shadow-xl"
            x-cloak
        >
            <!-- Logo e Nome do Projeto -->
            <div class="flex items-center justify-between h-20 border-b border-mti-border px-6 flex-shrink-0">
                <a href="{% url 'chat' %}" class="flex items-center gap-3 group">
                    <img src="{% static 'img/mti01.png' %}" alt="Logo MTI" class="h-10 w-auto transition-transform group-hover:scale-105">
                    <span class="text-xl font-bold text-white">GovTech <span class="text-mti-accent">IA</span></span>
                </a>
                <button @click="mobileSidebarOpen = false" class="lg:hidden text-mti-gray hover:text-white">
                    <i class="bi bi-x-lg text-xl"></i>
                </button>
            </div>

            <!-- Links de Navegação -->
            <nav class="flex-1 px-4 py-6 space-y-1 overflow-y-auto">
                <a href="{% url 'chat' %}" 
                   class="flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 group
                          {% if request.resolver_match.url_name == 'chat' %}bg-gradient-to-r from-mti-blue/20 to-transparent border border-mti-blue/30{% else %}hover:bg-mti-deep-blue/50{% endif %}">
                    <div class="p-2 rounded-lg {% if request.resolver_match.url_name == 'chat' %}bg-mti-blue/20 text-mti-blue{% else %}bg-primary-500/10 text-primary-500{% endif %} group-hover:bg-mti-accent/20 group-hover:text-mti-accent">
                        <i class="bi bi-robot text-lg"></i>
                    </div>
                    <span class="font-medium text-white">Assistente IA</span>
                    <i class="bi bi-chevron-right ml-auto text-mti-gray group-hover:text-mti-accent {% if request.resolver_match.url_name != 'chat' %}opacity-0 group-hover:opacity-100{% endif %}"></i>
                </a>
                
                <a href="{% url 'document_list' %}" 
                   class="flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 group
                          {% if request.resolver_match.url_name == 'document_list' %}bg-gradient-to-r from-mti-blue/20 to-transparent border border-mti-blue/30{% else %}hover:bg-mti-deep-blue/50{% endif %}">
                    <div class="p-2 rounded-lg {% if request.resolver_match.url_name == 'document_list' %}bg-mti-blue/20 text-mti-blue{% else %}bg-emerald-500/10 text-emerald-500{% endif %} group-hover:bg-mti-accent/20 group-hover:text-mti-accent">
                        <i class="bi bi-files text-lg"></i>
                    </div>
                    <span class="font-medium text-white">Documentos</span>
                    <i class="bi bi-chevron-right ml-auto text-mti-gray group-hover:text-mti-accent {% if request.resolver_match.url_name != 'document_list' %}opacity-0 group-hover:opacity-100{% endif %}"></i>
                </a>
                
                <a href="{% url 'dashboards' %}" 
                   class="flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 group
                          {% if request.resolver_match.url_name == 'dashboards' %}bg-gradient-to-r from-mti-blue/20 to-transparent border border-mti-blue/30{% else %}hover:bg-mti-deep-blue/50{% endif %}">
                    <div class="p-2 rounded-lg {% if request.resolver_match.url_name == 'dashboards' %}bg-mti-blue/20 text-mti-blue{% else %}bg-purple-500/10 text-purple-500{% endif %} group-hover:bg-mti-accent/20 group-hover:text-mti-accent">
                        <i class="bi bi-bar-chart-line text-lg"></i>
                    </div>
                    <span class="font-medium text-white">Dashboards</span>
                    <i class="bi bi-chevron-right ml-auto text-mti-gray group-hover:text-mti-accent {% if request.resolver_match.url_name != 'dashboards' %}opacity-0 group-hover:opacity-100{% endif %}"></i>
                </a>

                <!-- Divisor e Link para a Landing Page -->
                <div class="pt-4 mt-4 border-t border-mti-border/50">
                    <a href="{% url 'landing_page' %}" target="_blank"
                       class="flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 group hover:bg-mti-deep-blue/50">
                        <div class="p-2 rounded-lg bg-gray-500/10 text-mti-gray group-hover:bg-mti-accent/20 group-hover:text-mti-accent">
                            <i class="bi bi-box-arrow-up-right text-lg"></i>
                        </div>
                        <span class="font-medium text-white">Ver Site Público</span>
                    </a>
                </div>
            </nav>

            <!-- Perfil do Usuário no Rodapé da Sidebar -->
            <div class="px-4 py-4 border-t border-mti-border mt-auto">
                <div class="flex items-center gap-3 group">
                    <a href="{% url 'profile' %}" class="relative flex-shrink-0">
                        <template x-if="user.avatar !== 'none'">
                            <img class="h-10 w-10 rounded-full object-cover border-2 border-mti-blue/50 group-hover:border-mti-accent transition-all" 
                                 :src="user.avatar" alt="Avatar do usuário">
                        </template>
                        <template x-if="user.avatar === 'none'">
                            <div class="h-10 w-10 rounded-full border-2 border-mti-blue/50 group-hover:border-mti-accent transition-all avatar-initials" 
                                 x-text="user.initials || '..'"></div>
                        </template>
                        <span class="absolute bottom-0 right-0 h-3 w-3 bg-emerald-500 rounded-full border-2 border-mti-dark"></span>
                    </a>
                    <div class="flex-1 min-w-0">
                        <a href="{% url 'profile' %}" class="block truncate">
                            <p class="font-semibold text-white text-sm group-hover:text-mti-accent transition-colors truncate" x-text="user.name || 'Usuário'"></p>
                            <p class="text-xs text-mti-gray truncate" x-text="user.role"></p>
                        </a>
                    </div>
                    <a href="{% url 'logout' %}" 
                       class="ml-auto p-2 rounded-full text-mti-gray hover:bg-red-500/20 hover:text-red-500 transition-colors" 
                       title="Sair">
                        <i class="bi bi-box-arrow-right text-lg"></i>
                    </a>
                </div>
            </div>
        </aside>

        <!-- Conteúdo Principal -->
        <div class="flex-1 flex flex-col transition-all duration-300" :class="{'lg:ml-64': sidebarOpen}">
            <!-- Header -->
            <header class="flex items-center justify-between h-20 glass-effect border-b border-mti-border px-6 sticky top-0 z-20">
                <div class="flex items-center gap-4">
                    <button @click="toggleSidebar()" 
                            class="p-2 rounded-md text-mti-light-gray hover:bg-mti-blue hover:text-white transition-colors">
                        <i class="bi bi-list text-xl"></i>
                    </button>
                    
                    <div class="hidden lg:flex items-center gap-2 text-sm">
                        <a href="{% url 'chat' %}" class="text-mti-gray hover:text-mti-accent">Home</a>
                        <i class="bi bi-chevron-right text-xs text-mti-gray"></i>
                        <span class="text-white">{% block page_title %}Dashboard{% endblock %}</span>
                    </div>
                    <h1 class="text-xl font-bold text-white lg:hidden">{% block page_title_mobile %}{% block page_title_mobile_fallback %}Dashboard{% endblock %}{% endblock %}</h1>
                </div>

                <div class="flex items-center gap-4">
                    <div class="relative hidden md:block w-64">
                        <i class="bi bi-search absolute left-3 top-1/2 -translate-y-1/2 text-mti-gray"></i>
                        <input type="text" placeholder="Pesquisar..." 
                               class="w-full bg-mti-dark/50 border border-mti-border rounded-lg pl-10 pr-4 py-2 
                                      focus:outline-none focus:ring-2 focus:ring-mti-blue focus:border-transparent
                                      placeholder-mti-gray text-sm transition-all">
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <button class="p-2 rounded-full text-mti-light-gray hover:bg-mti-blue/20 hover:text-white transition-colors relative">
                            <i class="bi bi-bell-fill text-lg"></i>
                            <span class="absolute top-1 right-1 h-2 w-2 bg-red-500 rounded-full animate-pulse-slow"></span>
                        </button>
                        
                        <div class="hidden lg:flex items-center gap-2 ml-2">
                            <div class="text-right min-w-0">
                                <p class="text-sm font-medium text-white truncate" x-text="user.name || 'Usuário'"></p>
                                <p class="text-xs text-mti-gray truncate" x-text="user.role"></p>
                            </div>
                            <a href="{% url 'profile' %}" class="group flex-shrink-0">
                                <template x-if="user.avatar !== 'none'">
                                    <img class="h-10 w-10 rounded-full object-cover border-2 border-transparent group-hover:border-mti-accent transition-all" 
                                         :src="user.avatar" alt="Avatar">
                                </template>
                                <template x-if="user.avatar === 'none'">
                                    <div class="h-10 w-10 rounded-full border-2 border-transparent group-hover:border-mti-accent transition-all avatar-initials" 
                                         x-text="user.initials || '..'"></div>
                                </template>
                            </a>
                        </div>
                    </div>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-6">
                <div class="max-w-7xl mx-auto animate-fade-in">
                    {% if messages %}
                        <div class="mb-6 space-y-2">
                            {% for message in messages %}
                                <div x-data="{ show: true }" 
                                     x-show="show" 
                                     x-init="setTimeout(() => show = false, 5000)"
                                     x-transition:leave="transition ease-in duration-300"
                                     x-transition:leave-start="opacity-100 transform scale-100"
                                     x-transition:leave-end="opacity-0 transform scale-90"
                                     class="px-4 py-3 rounded-lg
                                            {% if message.tags == 'error' %}bg-red-500/20 text-red-200 border border-red-500/30
                                            {% elif message.tags == 'success' %}bg-emerald-500/20 text-emerald-200 border border-emerald-500/30
                                            {% else %}bg-blue-500/20 text-blue-200 border border-blue-500/30{% endif %}">
                                    <div class="flex items-center justify-between">
                                        <span>{{ message }}</span>
                                        <button @click="show = false" class="ml-2 text-xl">&times;</button>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    
                    {% block content %}
                    {% endblock content %}
                </div>
            </main>
            
            <footer class="py-4 px-6 border-t border-mti-border text-sm text-mti-gray bg-mti-dark/50">
                <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center">
                    <div class="mb-2 md:mb-0">
                        © {% now "Y" %} MTI GovTech IA. Todos os direitos reservados.
                    </div>
                    <div class="flex items-center gap-4">
                        <a href="#" class="hover:text-mti-accent transition-colors">Termos de Serviço</a>
                        <a href="#" class="hover:text-mti-accent transition-colors">Política de Privacidade</a>
                        <a href="#" class="hover:text-mti-accent transition-colors">Suporte</a>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    {% block extra_scripts %}{% endblock %}
</body>
</html>
