{% extends 'base.html' %}
{% load static humanize chat_extras %}

{% block content %}
<div id="vanta-bg" class="absolute inset-0 -z-10"></div>

<div class="pt-8">

    <section class="text-center mb-16">
        <h1 class="text-4xl md:text-5xl font-extrabold text-slate-800 dark:text-white leading-tight tracking-tight">
            {% if user.is_authenticated and user.first_name %}
                Olá, {{ user.first_name }}.
            {% else %}
                Bem-vindo ao Portal MTI
            {% endif %}
        </h1>
        <p class="max-w-2xl mx-auto mt-4 text-lg text-slate-600 dark:text-slate-300">
            Como podemos acelerar sua tomada de decisão hoje?
        </p>
        <form action="{% url 'chat_page' %}" method="get" class="mt-8 max-w-2xl mx-auto">
            <div class="relative">
                <input type="search" name="q" class="w-full pl-6 pr-16 py-4 text-lg bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm border border-slate-300 dark:border-slate-700 rounded-full shadow-lg focus:ring-4 focus:ring-mti-blue-500/50 focus:outline-none transition" placeholder="Pergunte sobre leis, portarias, processos...">
                <button type="submit" class="absolute inset-y-0 right-0 flex items-center justify-center h-full w-16 text-mti-blue-600 hover:text-mti-blue-800 dark:text-mti-blue-400 dark:hover:text-white">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </button>
            </div>
        </form>
    </section>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-2 space-y-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white/70 dark:bg-slate-800/70 backdrop-blur-sm p-6 rounded-2xl shadow-md border dark:border-slate-700">
                    <h4 class="font-semibold text-slate-600 dark:text-slate-300">Documentos na Base</h4>
                    <p class="text-3xl font-bold text-mti-blue-600 dark:text-mti-blue-400 mt-2">{{ stats.document_count|intcomma }}</p>
                </div>
                <div class="bg-white/70 dark:bg-slate-800/70 backdrop-blur-sm p-6 rounded-2xl shadow-md border dark:border-slate-700">
                    <h4 class="font-semibold text-slate-600 dark:text-slate-300">Consultas Hoje</h4>
                    <p class="text-3xl font-bold text-mti-blue-600 dark:text-mti-blue-400 mt-2">{{ stats.queries_today }}</p>
                </div>
                <div class="bg-white/70 dark:bg-slate-800/70 backdrop-blur-sm p-6 rounded-2xl shadow-md border dark:border-slate-700">
                    <h4 class="font-semibold text-slate-600 dark:text-slate-300">Usuários Online</h4>
                    <p class="text-3xl font-bold text-mti-blue-600 dark:text-mti-blue-400 mt-2">{{ stats.users_online }}</p>
                </div>
            </div>
        </div>

        <div class="lg:col-span-1">
            <div class="bg-white/70 dark:bg-slate-800/70 backdrop-blur-sm p-6 rounded-2xl shadow-md h-full border dark:border-slate-700">
                <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-4">Atividade Recente</h3>
                <ul class="space-y-4">
                    {% for activity in recent_activity %}
                    <li class="flex items-start space-x-3">
                        <div class="flex-shrink-0 mt-1">
                            {% include 'partials/_avatar.html' with user=activity.user %}
                        </div>
                        <div>
                            <p class="text-sm text-slate-700 dark:text-slate-200">
                                <span class="font-semibold">{{ activity.user.first_name|default:activity.user.username }}</span> consultou sobre "<span class="italic text-mti-blue-600 dark:text-mti-blue-400">{{ activity.pergunta|truncatewords:5 }}</span>"
                            </p>
                            <time class="text-xs text-slate-500 dark:text-slate-400">{{ activity.timestamp|naturaltime }}</time>
                        </div>
                    </li>
                    {% empty %}
                    <li class="text-sm text-slate-500">Nenhuma atividade recente.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Inicializa a animação 3D Vanta.js
    // A animação só será aplicada se o elemento #vanta-bg existir nesta página.
    if(document.getElementById('vanta-bg')) {
        VANTA.NET({
            el: "#vanta-bg",
            mouseControls: true,
            touchControls: true,
            gyroControls: false,
            minHeight: 200.00,
            minWidth: 200.00,
            scale: 1.00,
            scaleMobile: 1.00,
            // --- AJUSTES DE COR PARA O VISUAL ESCURO E SUTIL ---
            color: 0x0369a1,          // Um tom de azul mais fechado para as linhas (mti-blue-700)
            backgroundColor: 0x0f172a, // Cor de fundo bem escura (slate-900)
            points: 10.00,            // Menos pontos para um visual mais limpo
            maxDistance: 22.00,
            spacing: 17.00
        });
    }

    // O código para animação de rolagem pode ser adicionado aqui se desejado
});
</script>
{% endblock %}